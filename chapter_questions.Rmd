---
title: "Chapter Questions"
author: "Benjamin Wee"
date: "05/08/2018"
output: pdf_document
---
```{r message=FALSE, warning=FALSE}
library(rethinking)
```

# Chapter 3

```{r}
p_grid <- seq(from=0, to=1, length.out=1000)
prior <- rep(1, 1000)
likelihood <- dbinom(6, size = 9, prob = p_grid)
posterior <- likelihood * prior
posterior <- posterior / sum(posterior)
set.seed(100)
samples <- sample(p_grid, prob=posterior, size=1e4, replace=TRUE)
```

## Easy

### 3E1
```{r}
sum(posterior[p_grid < 0.2])
sum(samples < 0.2) / 1e4
```

### 3E2
```{r}
sum(posterior[p_grid > 0.8])
sum(samples > 0.8) / 1e4
```

### 3E3
```{r}
sum(posterior[p_grid > 0.2 & p_grid < 0.8])
sum(samples > 0.2 & samples < 0.8) / 1e4
```
### 3E4
```{r}
quantile(samples, 0.2)
```

### 3E5
```{r}
quantile(samples, 0.8)

```

### 3E6
```{r}
HPDI(samples, prob = 0.66)
```

### 3E7
```{r}
PI(samples, prob = 0.66)
```

## Medium

### 3M1
```{r}
p_grid <- seq(from=0, to=1, length.out=1000)
prior <- rep(1, 1000)
likelihood <- dbinom(8, size = 15, prob = p_grid)
posterior <- likelihood * prior
posterior <- posterior / sum(posterior)
set.seed(100)
samples <- sample(p_grid, prob=posterior, size=1e4, replace=TRUE)
```



### 3M2
```{r}
HPDI(samples, prob = 0.9)
```

### 3M3
```{r}
w <- rbinom(1e4, size = 15, prob = samples)
table(w)[9] / 1e4 # Proportion ('probability') of 8 waters from 1e4 draws of size 15 each.
```

### 3M4
```{r}
w <- rbinom(1e4, size = 9, prob = samples)
table(w)[7] / 1e4
```

### 3M5
```{r}
prior <- c(rep(0, 500), rep(1, 500)) # Puts basically zero probability on proportion of water = 0
likelihood <- dbinom(8, size = 15, prob = p_grid)
posterior <- likelihood * prior
posterior <- posterior / sum(posterior)
set.seed(100)
samples <- sample(p_grid, prob=posterior, size=1e4, replace=TRUE)

HPDI(samples, prob = 0.9)

w <- rbinom(1e4, size = 15, prob = samples)
table(w)[8] / 1e4 # No samples of 0, so indexing changesrelative to ## 3M3

w <- rbinom(1e4, size = 9, prob = samples)
table(w)[7] / 1e4
```


## Hard
```{r}
data(homeworkch3)
```
### 3H1
```{r}
p_grid <- seq(from = 0, to = 1, length.out = 1000)
prior <- rep(1, 1000)
likelihood <- dbinom((sum(birth1) + sum(birth2)), size = 200, prob = p_grid)
posterior <- likelihood * prior
posterior <- posterior / sum(posterior)

plot(posterior ~ p_grid, type = "l")
```

### 3H2
```{r}
set.seed(100)
samples <- sample(p_grid, prob=posterior, size=1e4, replace=TRUE)

HPDI(samples, prob = 0.5)
HPDI(samples, prob = 0.89)
HPDI(samples, prob = 0.97)

```

### 3H3
```{r}
w <- rbinom(1e4, size = 200, prob = samples)
boys_born = sum(birth1 + birth2)
dens(w, adj = 0.1)
abline(v = boys_born, col = "red")
```

### 3H4
```{r}
w <- rbinom(1e4, size = 100, prob = samples)
dens(w, adj = 0.1)
abline(v = sum(birth1), col = "blue") # Does not fit number of boys in birth1 well (not represented on scale)
```

### 3H5
```{r}
# Number of second birth boys given first birth was a girl
births_after_girls <- length(birth2[birth1 == 0]) # 49 second births after female first birth
posterior_predictive_distribution <- rbinom(1e4, size = births_after_girls, prob = samples)
dens(posterior_predictive_distribution, adj = 0.1)
abline(v = sum(birth2[birth1 == 0]), col = "blue") # Posterior predictive distribution does not capture observed count of boys following girls well. The model is built under the assumption that first borns and second borns are independent. However, once we condition on female first borns, the number of second born males exceeds what is broadly expected from the model. This may suggest a correlation between first and second born children, providing evidence against the assumption of independence. 
```


# Chapter 4
## Easy


$$
y_i\sim Normal(\mu,\sigma) \\
\mu\sim Normal(0, 10) \\
\sigma\sim Uniform(0, 10)
$$

### 4E1
$y_i\sim Normal(\mu,\sigma)$ is the likelihood

### 4E2
2 parameters in the posterior, $\mu$ and $\sigma$

### 4E3
$$
Pr(\mu,\sigma|y_i) = \frac{Pr(y_i|\mu,\sigma) Pr(\mu) Pr(\sigma)}{Pr(y_i)} \\
= \frac{\Pi_i Normal(y_i|\mu,\sigma) Normal(\mu | 0, 10) Uniform(\sigma|0, 10)}{\int\int\Pi_i Pr(y_i)Normal(y_i|\mu,\sigma) Normal(\mu | 0, 10) Uniform(\sigma|0, 10)d\mu d\sigma}
$$

### 4E4
$\mu_i = \alpha + \beta x_i$ is the linear model

### 4E5
3 parameters in the posterior, $\alpha$, $\beta$ and $\sigma$


## Medium
$$
y_i\sim Normal(\mu,\sigma) \\
\mu\sim Normal(0, 10) \\
\sigma\sim Uniform(0, 10)
$$

### 4M1
```{r}
sample_mu <- rnorm(1e4, 0, 10)
sample_sigma <- runif(1e4, 0, 10)
y <- rnorm(1e4, sample_mu, sample_sigma)
```

### 4M2
```{r}
model <- alist(y ~ dnorm(mu, sigma),
               mu ~ dnorm(0, 10),
               sigma ~ dunif(0, 10))
```

### 4M3
$$
y_i\sim Normal(\mu,\sigma) \\
\mu = \alpha + \beta x_i \\
\alpha\sim Normal(0, 50) \\
\beta\sim Normal(0, 10) \\
\sigma\sim Uniform(0, 50)
$$

### 4M4
$$
Height_i\sim Normal(\mu,\sigma) \\
\mu = \alpha + \beta time_i \\
\alpha\sim Normal(160, 100) \\
\beta\sim Normal(0, 10) \\
\sigma\sim Uniform(0, 50)
$$
Wide prior for intercept. Height does not have a linear relationship with age/time. Most likely some concave function.

If adolescent students, probably some growth across teenage years. 

### 4M5
$$
Height_i\sim Normal(\mu,\sigma) \\
\mu = \alpha + \beta time_i \\
\alpha\sim Normal(120, 100) \\
\beta\sim Normal(2, 10) \\
\sigma\sim Uniform(0, 50)
$$

Mean of alpha becomes 120 to reflect average height of first years. Positive mean to slope to reflect overall growth for a year. 

### 4M6
$$
Height_i\sim Normal(\mu,\sigma) \\
\mu = \alpha + \beta time_i \\
\alpha\sim Normal(120, 100) \\
\beta\sim Normal(2, 10) \\
\sigma\sim Uniform(0, 70)
$$

Set upper bound for variance of height to be 70. Higher than observed upper bound to account for potential variation that was not previously observed (although should probably not have uniform weight on values above 64).

## Hard

### 4H1

Using code model from 4.38 

```{r message=FALSE, warning=FALSE}
library(rethinking)
data(Howell1)
d <- Howell1

# Define univariate linear model
m4.3 <- map(
  alist(
    height ~ dnorm( mu , sigma ) ,
    mu <- a + b*weight ,
    a ~ dnorm( 156 , 100 ) ,
    b ~ dnorm( 0 , 10 ) ,
    sigma ~ dunif( 0 , 50 )
) ,
data=d)

missing_data <- as.data.frame(c(46.95, 43.72, 64.78, 32.59, 54.63))
names(missing_data) <- "missing"

# Simulate expected (mean) heights 
mu_missing <- link(m4.3, data = data.frame(weight=missing))
mu_missing_mean <- apply(mu_missing, 2, mean)
mu_missing_hpdi <- apply(mu_missing, 2, HPDI, prob = 0.89)

print(rbind(mu_missing_mean, mu_missing_hpdi))
```

### 4H2
```{r}
# 4H2a
library(rethinking)
data(Howell1)
d <- Howell1[Howell1$age < 18, ]

model <- map(
  alist(
    height ~ dnorm( mu , sigma ) ,
    mu <- a + b*weight ,
    a ~ dnorm( 100 , 100 ) ,
    b ~ dnorm( 0 , 10 ) ,
    sigma ~ dunif( 0 , 50 )
) ,
data=d)

precis(model)
```

```{r}
# 4H2b
# Define sequence of weights
weight.seq <- seq(from = 1, to = 50)

# Calculate mu
mu <- link(model, data = data.frame(weight = weight.seq))

# Calculate mu.mean
mu.mean <- apply(mu, 2, mean)
mu.HPDI <- apply(mu, 2, HPDI, prob = 0.89)

# Simulate heights
sim.height <- sim(model, data = list(weight=weight.seq))
height.HPDI <- apply(sim.height, 2, HPDI, prob = 0.89)

# Plot 
plot(height ~ weight, data = d, col = col.alpha(rangi2, 0.5))
lines(weight.seq, mu.mean)
shade(mu.HPDI, weight.seq)
shade(height.HPDI, weight.seq)
```

#### 4H3c
Plotted data does not really have a linear relationship. Maybe add a polynomial regressor to account for concavity in the relationship between height and weight. 

### 4H3
```{r}
library(rethinking)
data(Howell1)
d <- Howell1

log_model <- map(
  alist(
    height ~ dnorm( mu , sigma ) ,
    mu <- a + b*log(weight),
    a ~ dnorm( 178 , 100 ) ,
    b ~ dnorm( 0 , 100 ) ,
    sigma ~ dunif( 0 , 50 )
) ,
data=d)

precis(log_model)
```

```{r}
#### 4H3b
# Define sequence of weights
weight.seq <- seq(from = 1, to = 70)

# Extract samples from model
posterior <- extract.samples(log_model, n = 1e5)

# Calculate mu
mu_link <- function(weight) posterior$a + posterior$b * log(weight)
mu <- sapply(X = weight.seq, FUN = mu_link)

# Calculate mu.mean
mu.mean <- apply(mu, 2, mean)
mu.HPDI <- apply(mu, 2, HPDI, prob = 0.97)

# Simulate heights
height.link <- function(weight) rnorm(n = nrow(posterior), mean = mu_link(weight), sd = posterior$sigma)
height.samples <- sapply(weight.seq, FUN = height.link)
height.HPDI <- apply(height.samples, 2, HPDI, prob = 0.97)

plot( height ~ weight , data=Howell1,
col=col.alpha(rangi2,0.4) )
lines(weight.seq, mu.mean)
shade(mu.HPDI, weight.seq)
shade(height.HPDI, weight.seq)
```



# Chapter 5
## Easy
### 5E1
$$
\mu_i = \beta_x x_i + \beta_z z_i \\
\mu_i = \alpha + \beta_x x_i + \beta_z z_i
$$

### 5E2
$$
diversity = \alpha + \beta_1 latitude + \beta_2 PlantDiversity
$$

### 5E3
$$
diversity = \alpha + \beta_1 latitude + \beta_2 PlantDiversity
$$

### 5E4
$$ 
\mu_i = \alpha + \beta_A A_i + \beta_B B_i + \beta_D D_i \\
\mu_i = \alpha + \beta_B B_i + \beta_C C_i + \beta_D D_i \\
\mu_i = \alpha_A A_i + \alpha_B B_i + \alpha_C C_i + \alpha_D D_i \\
$$

## Medium
### 5M1
n = 1e4

